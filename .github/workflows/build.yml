name: Build

on:
  push:
    branches: main
  pull_request:
    branches: '*'
  schedule:
    # Run weekly on Mondays at 00:00 UTC (for test_setup_script_full)
    - cron: '0 0 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint-test-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Base Setup
      uses: jupyterlab/maintainer-tools/.github/actions/base-setup@v1

    - name: Install dependencies
      run: python -m pip install -U "jupyterlab>=4.0.0,<5"

    - name: Lint the extension
      run: |
        set -eux
        jlpm
        jlpm run lint:check

    - name: Run tests & coverage
      run: |
        set -eux
        jlpm test:coverage

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7

    - name: Build the extension
      run: |
        set -eux
        python -m pip install .[test]
        jupyter server extension list
        jupyter server extension list 2>&1 | grep -ie "qiskit_code_assistant_jupyterlab.*OK"

        jupyter labextension list
        jupyter labextension list 2>&1 | grep -ie "qiskit-code-assistant-jupyterlab.*OK"
        python -m jupyterlab.browser_check --no-browser-test

    - name: Package the extension
      run: |
        set -eux

        pip install build
        python -m build
        pip uninstall -y "qiskit_code_assistant_jupyterlab" jupyterlab

    - name: Upload extension packages
      uses: actions/upload-artifact@v4
      with:
        name: extension-artifacts
        path: dist/qiskit_code_assistant_jupyterlab*
        if-no-files-found: error

  test_isolated:
    needs: lint-test-build
    runs-on: ubuntu-latest

    steps:
    - name: Install Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        architecture: 'x64'
    - uses: actions/download-artifact@v4
      with:
        name: extension-artifacts
    - name: Install and Test
      run: |
        set -eux
        # Remove NodeJS, twice to take care of system and locally installed node versions.
        sudo rm -rf $(which node)
        sudo rm -rf $(which node)

        pip install "jupyterlab>=4.0.0,<5" qiskit_code_assistant_jupyterlab*.whl

        jupyter server extension list
        jupyter server extension list 2>&1 | grep -ie "qiskit_code_assistant_jupyterlab.*OK"

        jupyter labextension list
        jupyter labextension list 2>&1 | grep -ie "qiskit-code-assistant-jupyterlab.*OK"
        python -m jupyterlab.browser_check --no-browser-test


  test_setup_script:
    name: Test Local Setup Script
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Verify script syntax
        run: |
          bash -n setup_local.sh
          echo "✓ Script syntax is valid"

      - name: Test --help flag
        run: |
          output=$(bash setup_local.sh --help 2>&1)
          echo "$output" | grep -i "usage"
          echo "$output" | grep -i "qiskit"
          echo "✓ Help flag works"

      - name: Test --list-models flag
        run: |
          output=$(bash setup_local.sh --list-models 2>&1)
          echo "$output" | grep -i "qwen2.5-coder-14b"
          echo "$output" | grep -i "mistral-small-24b"
          echo "$output" | grep -i "granite-3.3-8b"
          echo "✓ List models works"

      - name: Test script functions are defined correctly
        run: |
          # Source the script and test that key functions exist
          source setup_local.sh --help > /dev/null 2>&1 || true
          # Test that the script can detect OS (by parsing the file)
          grep -q "detect_os()" setup_local.sh
          grep -q "install_or_upgrade_extension()" setup_local.sh
          grep -q "detect_package_manager()" setup_local.sh
          echo "✓ Key functions are defined"

      - name: Install JupyterLab for testing
        run: |
          pip install jupyterlab>=4.3.0

      - name: Install extension
        run: |
          pip install .
          jupyter server extension list
          jupyter labextension list
          echo "✓ Extension installed successfully"

      - name: Test extension upgrade
        run: |
          # Test that upgrade flag works
          pip install --upgrade .
          echo "✓ Extension upgrade works"

  check_setup_script_changes:
    name: Check if setup script changed
    runs-on: ubuntu-latest
    outputs:
      setup_changed: ${{ steps.changes.outputs.setup_script }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if setup script was modified
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            setup_script:
              - 'setup_local.sh'

  test_setup_script_full:
    name: Test Full Setup (with Ollama model)
    needs: check_setup_script_changes
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Only run if setup script changed, manually triggered, on release tags, or scheduled
    if: |
      needs.check_setup_script_changes.outputs.setup_changed == 'true' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get Ollama model cache key
        id: ollama-cache-key
        run: |
          # Cache key based on the default model name in setup_local.sh
          MODEL=$(grep "DEFAULT_MODEL=" setup_local.sh | head -1 | cut -d'"' -f2)
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "cache-key=ollama-models-$MODEL" >> $GITHUB_OUTPUT

      - name: Cache Ollama models
        uses: actions/cache@v4
        id: ollama-cache
        with:
          path: ~/.ollama
          key: ${{ steps.ollama-cache-key.outputs.cache-key }}
          restore-keys: |
            ollama-models-

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama service
        run: |
          ollama serve &
          sleep 5
          curl http://localhost:11434

      - name: Run full setup script
        run: |
          # Run the setup script in non-interactive mode
          # The script will auto-install JupyterLab and pull the model if not cached
          bash setup_local.sh --non-interactive

      - name: Verify Ollama model is installed
        run: |
          ollama list
          # Check that the default model exists
          ollama list | grep -i "qwen2.5-coder-14b-qiskit-GGUF"

      - name: Test model inference
        run: |
          # Quick inference test
          echo "from qiskit import QuantumCircuit" | ollama run qwen2.5-coder-14b-qiskit-GGUF --verbose
          echo "✓ Model inference works"

      - name: Verify JupyterLab configuration
        run: |
          # Check config files were created
          cat ~/.jupyter/lab/user-settings/@qiskit/qiskit-code-assistant-jupyterlab/plugin.jupyterlab-settings
          cat ~/.jupyter/lab/user-settings/qiskit-code-assistant-jupyterlab/plugin.jupyterlab-settings
          # Verify serviceUrl is set to Ollama
          grep -q "http://localhost:11434" ~/.jupyter/lab/user-settings/@qiskit/qiskit-code-assistant-jupyterlab/plugin.jupyterlab-settings
          echo "✓ Configuration is correct"

  check_links:
    name: Check Links
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: jupyterlab/maintainer-tools/.github/actions/base-setup@v1
      - uses: jupyterlab/maintainer-tools/.github/actions/check-links@v1
